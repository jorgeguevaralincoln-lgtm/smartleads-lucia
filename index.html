<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>SmartLeads | Asistente Inteligente</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f2f2f7;
      color: #1d1d1f;
      -webkit-tap-highlight-color: transparent;
    }

    .chat-container {
      height: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      padding-bottom: 20px;
    }

    .bubble {
      max-width: 85%;
      padding: 14px 18px;
      border-radius: 22px;
      margin-bottom: 6px;
      font-size: 15px;
      line-height: 1.5;
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
      animation: slideIn .25s ease-out;
      word-wrap: break-word;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .lucia {
      background: #fff;
      align-self: flex-start;
      border-bottom-left-radius: 6px;
    }

    .user {
      background: #007AFF;
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 6px;
    }

    .quick-actions-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .quick-btn {
      border: 1px solid #007AFF;
      color: #007AFF;
      background: #fff;
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }

    .ws-button {
      background: #34C759;
      color: white;
      padding: 16px;
      border-radius: 18px;
      font-weight: 600;
      text-align: center;
      margin-top: 16px;
    }

    .admin-trigger {
      cursor: pointer;
      opacity: .12;
    }

    .view-hidden { display: none !important; }
  </style>
</head>

<body class="flex items-center justify-center min-h-screen">

<!-- ================= CLIENT VIEW ================= -->
<div id="client-view" class="w-full max-w-md bg-white h-screen flex flex-col overflow-hidden">

  <div class="p-4 border-b flex justify-between items-center">
    <div>
      <h1 class="font-bold">Lucía</h1>
      <p class="text-xs text-green-600 font-semibold">Asistente en línea</p>
    </div>
  </div>

  <div id="chat-box" class="chat-container p-4 bg-[#f5f5f7] flex-grow">

    <div class="bubble lucia">
      Hola, soy <b>Lucía</b>, su Asistente de beneficios.<br><br>
      ¿Desea continuar para conocer sus beneficios?
    </div>

    <div class="quick-actions-container">
      <button class="quick-btn" onclick="sendMessage('Sí, continuar')">Sí, continuar</button>
      <button class="quick-btn" onclick="sendMessage('No me interesa')">No me interesa</button>
    </div>

  </div>

  <div class="p-4 border-t">
    <form id="chat-form" class="flex gap-2">
      <input id="user-input" class="flex-grow bg-gray-100 rounded-full px-4 py-2" placeholder="Escribe aquí..." />
      <button class="bg-[#007AFF] text-white rounded-full px-4">➤</button>
    </form>

    <p class="text-center text-[10px] mt-2">
      <span class="admin-trigger" onclick="openLoginModal()">SmartLeads</span>
    </p>
  </div>
</div>

<!-- ================= LOGIN MODAL ================= -->
<div id="login-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
  <div class="bg-white p-6 rounded-xl w-80">
    <h2 class="font-bold mb-4">Acceso Admin</h2>
    <form id="login-form">
      <input id="admin-email" type="email" class="w-full border p-2 mb-3" placeholder="Correo" />
      <input id="admin-pass" type="password" class="w-full border p-2 mb-4" placeholder="Contraseña" />
      <button class="w-full bg-blue-600 text-white py-2 rounded">Entrar</button>
    </form>
    <p id="login-error" class="text-red-500 text-xs mt-2 hidden"></p>
  </div>
</div>

<!-- ================= ADMIN VIEW ================= -->
<div id="admin-view" class="view-hidden w-full max-w-5xl bg-white h-screen flex flex-col">

  <div class="p-4 bg-slate-900 text-white flex justify-between">
    <h1 class="font-bold">SmartLeads CRM</h1>
    <button onclick="logoutAdmin()" class="text-xs bg-red-500 px-3 py-1 rounded">Salir</button>
  </div>

  <div class="flex-grow overflow-y-auto p-4 bg-gray-50">
    <table class="w-full bg-white rounded-xl">
      <thead>
        <tr class="text-xs text-gray-400">
          <th class="p-3 text-left">Fecha</th>
          <th class="p-3 text-left">Prospecto</th>
          <th class="p-3 text-left">Estado</th>
          <th class="p-3 text-right">Acción</th>
        </tr>
      </thead>
      <tbody id="leads-table-body"></tbody>
    </table>
  </div>

</div>

<!-- ================= SCRIPT ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, updateDoc, serverTimestamp, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA_-x6UEEVEJ7uAY8ohCrDussZ938QQ0B0",
  authDomain: "luciaai-46c75.firebaseapp.com",
  projectId: "luciaai-46c75"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const sessionId = crypto.randomUUID();
let currentUser = null;

onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    if (user.isAnonymous) createLead();
  } else {
    signInAnonymously(auth);
  }
});

async function createLead() {
  await setDoc(doc(db, "artifacts", "smartleads-prod", "public", "data", "leads", sessionId), {
    userId: currentUser.uid,
    startedAt: serverTimestamp(),
    updatedAt: serverTimestamp(),
    status: "Navegando",
    summary: "Pendiente..."
  }, { merge: true });
}

window.sendMessage = async function(text) {
  if (!text) return;

  appendBubble("user", text);

  if (text.toLowerCase().includes("sí")) {
    setTimeout(() => {
      appendBubble("lucia", "Perfecto. Permítame orientarle mejor.");
    }, 500);
  }
};

function appendBubble(role, text) {
  const div = document.createElement("div");
  div.className = "bubble " + role;
  div.innerHTML = text;
  document.getElementById("chat-box").appendChild(div);
  div.scrollIntoView();
}

window.openLoginModal = () => {
  document.getElementById("login-modal").classList.remove("hidden");
};

document.getElementById("login-form").addEventListener("submit", async e => {
  e.preventDefault();
  try {
    await signInWithEmailAndPassword(
      auth,
      document.getElementById("admin-email").value,
      document.getElementById("admin-pass").value
    );
    document.getElementById("login-modal").classList.add("hidden");
    switchView("admin");
    loadLeads();
  } catch {
    document.getElementById("login-error").textContent = "Credenciales incorrectas";
    document.getElementById("login-error").classList.remove("hidden");
  }
});

function loadLeads() {
  onSn
